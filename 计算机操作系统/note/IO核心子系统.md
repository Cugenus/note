
### I/O软件的层次结构

![[Pasted image 20240604144928.png]]

- 用户层软件
用户层软件实现了与用户交互的接口，用户可直接使用该层提供的、与I/O操作相关的库函数对设备进行操作；用户层软件将用户请求翻译成格式化的I/O请求，并通过“系统调用”请求操作系统内核的服务

- 设备独立性软件
设备独立性软件，又称设备无关性软件，与设备的硬件特性无关的功能几乎都在这一层实现
1、向上层提供统一的调用接口
2、设备的保护
3、差错处理
4、设备的分配与回收
5、数据缓冲区管理
6、建立逻辑设备名到物理设备名的映射关系，根据设备类型选择调用相应的驱动程序

- 设备驱动程序
设置设备寄存器、检查设备状态

- 中断处理程序
进行中断处理

- 硬件
执行I/O操作，有机械部件、电子部件组成
***
### 应用程序接口和驱动程序接口

#### 应用程序接口

- 字符设备接口
get/put系统调用：向字符设备读/写一个字符

- 块设备接口
read/write系统调用：向块设备的读写指针位置读/写多个字符
seek系统调用：修改读写指针位置

- 网络设备接口
网络设备接口，又称“网络套接字(socket)接口”；
socket系统调用：创建一个网络套接字，需指明网络协议
bind：将套接字绑定到某个本地“端口
connect：将套接字连接到远程地址
read/write：从套接字读/写数据
#### 驱动程序接口

不同的操作系统，对设备驱动程序接口的标准各不相同，设备厂商必须根据操作系统的接口要求，开发相应的设备驱动程序，设备才能被使用
***
### 设备独立性软件

#### 假脱机技术

用软件的方式模拟脱机技术，由用户层软件实现

输入井和输出井：模拟脱机输入/输出时的磁带
输入进程和输出进程：模拟脱机输入/输出时的外围控制机
输入缓冲区和输出缓冲区：内存中的缓冲区
#### 设备的分配与回收

##### 设备分配时的考虑因素

- 设备的固有属性
独占设备：一个时段只能分配给一个进程
共享设备：可同时分配给多个进程使用
虚拟设备：采用假脱机技术将独占设备改造成虚拟的共享设备，可同时分配给多个进程使用

- 设备分配算法
先来先服务、优先级高者优先、短任务优先等

- 设备分配中的安全性：
安全分配方式：为进程分配一个设备后就将进程阻塞，本次I/O完成后才将进程唤醒；不会死锁，只能串行工作
不安全分配方式：进程发出I/O请求后，系统为其分配I/O设备，进程可继续执行，之后还可以发出新的I/O请求；可以并行工作，有可能死锁
##### 静态分配与动态分配

- 静态分配
进程运行前为其分配全部所需资源，运行结束后归还资源，破坏了“请求和保持”条件，不会发生死锁

- 动态分配
进程运行过程中动态申请设备资源
##### 设备分配管理中的数据结构

- 设备控制表(DCT)
系统为每个设备配置一张DCT，用于记录设备情况

- 系统设备表(SDT)
记录了系统中全部设备的情况，每个设备对应一个表目

- 控制器控制表(COCT)
每个设备控制器都会对应一张COCT，操作系统根据COCT的信息对控制器进行操作和管理

- 通道控制表(CHCT)
每个通道都会对应一张CHCT，操作系统根据CHCT的信息对通道进行操作和管理
##### 设备分配的步骤

1、根据进程请求的物理设备名查找SDT
2、根据SDT找到DCT，若设备忙碌则将进程PCB挂到设备等待队列中，不忙碌则将设备分配给进程
3、根据DCT找到COCT，若控制器忙碌则将进程PCB挂到控制器等待队列中，不忙碌则将控制器分配给进程
4、根据COCT找到CHCT，若通道忙碌则将进程PCB挂到通道等待队列中，不忙碌则将通道分配给进程
##### 设备分配步骤的改进方法

改进1、根据进程请求的逻辑设备名查找SDT
改进2、查找SDT，找到用户进程指定类型的、并且空闲的设备，将其分配给该进程，操作系统在逻辑设备表(LUT)中新增一个表项
#### 缓冲区管理

缓冲区是一个存储区域，可以由专门的硬件寄存器组成，也可利用内存作为缓冲区

- 缓冲区的作用
缓和CPU与I/O设备之间速度不匹配的矛盾
减少对CPU的中断频率，放宽对CPU中断相应时间的限制
解决数据粒度不匹配的问题
提高CPU与I/O设备之间的并行性

- 单缓冲
操作系统会在主存中分配一个缓冲区(当缓冲区数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出; 当缓冲区为空时可以往缓冲区冲入数据，但必须把缓冲区充满以后，才能从缓冲区把数据传出)

- 双缓冲
操作系统会在主存中分配两个缓冲区

- 循环缓冲
将多个大小相等的缓冲区链接成一个循环队列

- 缓冲池
缓冲池由系统中共用的缓冲区组成；
三个队列：空缓冲队列、输入队列、输出队列
四种工作缓冲区：用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区、用于收容输出数据的工作缓冲区、用于提取输出数据的工作缓冲区
***

