
### 同步和互斥和基本概念

- 进程同步
同步亦称直接制约关系，它是指为完成某种任务而建立的两个或多个进程，这些进程因为需要在某些位置上协调它们的工作次序而产生的制约关系

- 进程互斥
互斥亦称间接制约关系；进程互斥指当一个进程访问某临界资源时，另一个想要访问该临界资源的进程必须等待

空闲让进：临界区空闲时，可以允许一个请求进入临界区的进程立即进入临界区
忙则等待：当已有进程进入临界区时，其他试图进入临界区的进程必须等待
有限等待：对请求访问的进程，保证能在有限时间内进入临界区(保证不会饥饿)
让权等待：当进程不能进入临界区时，应立即释放处理机，防止进程忙等待
***
### 进程互斥的实现

#### 软件实现方法

##### 单标志法

- 算法规则
两个进程在访问完临界区后会把使用临界区的权限转交给另一个进程，每个进程进入临界区的权限只能被另一个进程赋予

- 特点
违背空闲让进原则
#####  双标志先检查

- 算法规则
设置一个布尔型数组 flag，数组中各个元素用来标记各进程想进入临界区的意愿，每个进程在进入临界区之前先检查当前有没有别的进程想进入临界区，如果没有，则把自身对应的标志 flag\[i] 设为 true，之后开始访问临界区

- 特点
违背忙则等待原则
##### 双标志后检查

- 算法规则
双标志先检查法的改版，先“上锁”后“检查”

- 特点
违背了空闲让进、有限等待原则
##### Peterson 算法

- 算法规则
表达意愿->谦让->检查(其他进程是否有意愿、最后表达谦让的进程)->访问

- 特点
违背了让权等待
#### 硬件实现方法

##### 中断屏蔽

- 算法规则
利用“开/关中断指令”实现(即在某进程开始访问临界区到结束访问为止都不允许被中断，也就不能发生进程切换，因此也不可能发生两个同时访问临界区的情况)

- 特点
优点：简单、高效
缺点:不适用于多处理机:只适用于操作系统内核进程，不适用于用户进程(因为开/关中断指令只能运行在内核态，这组指令如果能让用户随意使用会很危险)
##### TestAndSet指令

- 算法规则
简称TS 指令或TSL 指令，TSL 指令把“上锁”和“检查”操作用硬件的方式变成了一气呵成的原子操作

- 特点
优点：实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；适用于多处理机环境
缺点：违背让权等待原则，暂时无法进入临界区的进程会占用CPU并循环执行TSL指令，从而导致“忙等”
##### swap指令

- 算法规则
简称 XCHG 指令或称 Exchange 指令，逻辑上来看 Swap 和 TSL 并无太大区别

- 特点
优点：实现简单，无需像软件实现方法那样严格检查是否会有逻辑漏洞；适用于多处理机环境
缺点：违背让权等待原则
***
### 互斥锁

解决临界区最简单的工具就是互斥锁(mutex lock)；一个进程在进入临界区时应获得锁，在退出临界区时释放锁；函数 acquire() 获得锁，而函数 release() 释放锁

- 特点
缺点：**违背让权等待**，当有一个进程在临界区中，任何其他进程在进入临界区时必须连续循环调用 acquire() ；当多个进程共享同一CPU时，就浪费了CPU周期；
优点：等待期间不用切换进程上下文，一个核忙等，其他核照常工作，并快速释放临界区

- 自旋锁
需要连续循环忙等的互斥锁，都可称为自旋锁(spin lock) ，如TSL指令、swap指令、单标志法
***
### 信号量机制

信号量其实就是一个变量(可以是一个整数，也可以是更复杂的记录型变量)，可以用一个信号量来表示系统中某种资源的数量

wait(S) 原语和 signal(S) 原语，简称为 P、V 操作
#### 整形信号量

- 规则
用一个整数型的变量作为信号量，用来表示系统中某种资源的数量

- 特点
“检查”和“上锁”一气呵成，避免了并发、异步导致的问题存在的问题；违背了让权等待
#### 记录型信号量

- 规则
如果剩余资源数不够，使用block原语使进程从运行态进入阻塞态，并把挂到信号量 S 的等待队列(即阻塞队列)中，释放资源后，若还有别的进程在等待这种资源，则使用wakeup原语唤醒等待队列中的一个进程，该进程从阻塞态变为就绪态

- 特点
满足让权等待
#### 实现进程互斥

1、分析并发进程的关键活动，划定临界区
2、设置互斥信号量 mutex，初值为 1
3、在进入区P(mutex)申请资源
4、在退出区V(mutex)释放资源
#### 实现进程同步

1、分析什么地方需要实现“同步关系”
2、设置同步信号量 S初始为 0
3、在“前操作”之后执行V(S)
4、在“后操作”之前执行P(S)
#### 实现进程的前驱关系

多级同步问题，每一对前驱关系都是一个进程同步问题

1、要为每一对前驱关系各设置一个同步信号量
2、在“前操作”之后对相应的同步信号量执行V操作
3、在“后操作”之前对相应的同步信号量执行P操作
***
### 经典同步问题

#### 生产者-消费者问题

略
#### 多生产者-多消费者问题

略
#### 吸烟者问题

略
#### 读者-写者问题

略
#### 哲学家进餐问题

略
***
### 管程

管程是一种特殊的软件模块，用于解决信号量机制编程麻烦、易出错的问题，由这些部分组成：
1、局部于管程的共享数据结构说明
2、对该数据结构进行操作的一组过程
3、对局部于管程的共享数据设置初始值的语句
4、有一个名字

管程的基本特征：
1、局部于管程的数据只能被局部于管程的过程所访问
2、一个进程只有通过调用管程内的过程才能进入管程访问共享数据
3、每次仅允许一个进程在管程内执行某个内部过程

引入管程的目的是要更方便地实现进程互斥和同步：
1、需要在管程中定义共享数据
2、需要在管程中定义用于访问这些共享数据的“入口”--(其实就是一些函数)
3、只有通过特定的“入口”才能访问共享数据
4、每次只能开放其中一个“入口”，并且只能让一个进程或线程进入
5、可在管程中设置条件变量及等待/唤醒操作以解决同步问题
***